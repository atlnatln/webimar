<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İzmir Konum Otomatik Tamamlama Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-title {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        .test-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #2980b9;
        }
        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            min-height: 100px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
        .warning { color: #f39c12; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">🗺️ İzmir Konum Otomatik Tamamlama Test Sistemi</h1>
        
        <div class="test-section">
            <h3>📍 CSV Veri Testi</h3>
            <button class="test-button" onclick="testCSVData()">CSV Dosyasını Test Et</button>
            <button class="test-button" onclick="testLocationParsing()">Konum Parsing Test</button>
            <div id="csv-results" class="result-box">Test sonuçları burada görünecek...</div>
        </div>

        <div class="test-section">
            <h3>🔍 Arama Algoritması Testi</h3>
            <button class="test-button" onclick="testSearchAlgorithm()">Arama Testi</button>
            <button class="test-button" onclick="testPerformance()">Performans Testi</button>
            <div id="search-results" class="result-box">Arama sonuçları burada görünecek...</div>
        </div>

        <div class="test-section">
            <h3>📊 Koordinat Doğrulama Testi</h3>
            <button class="test-button" onclick="testCoordinateValidation()">Koordinat Doğrula</button>
            <button class="test-button" onclick="testZoomFunctionality()">Zoom Fonksiyonu Test</button>
            <div id="coordinate-results" class="result-box">Koordinat sonuçları burada görünecek...</div>
        </div>

        <div class="test-section">
            <h3>🎯 React Entegrasyon Testi</h3>
            <a href="http://localhost:3000/bag-evi" target="_blank" class="test-button">Bağ Evi Sayfasını Aç</a>
            <button class="test-button" onclick="testReactIntegration()">Entegrasyon Kontrolü</button>
            <div id="react-results" class="result-box">React entegrasyon sonuçları burada görünecek...</div>
        </div>
    </div>

    <script>
        let csvData = [];
        
        // Türkçe karakterleri normalize etme fonksiyonu
        function normalizeText(text) {
            return text
                .toLowerCase()
                .normalize('NFD') // Unicode normalize
                .replace(/[\u0300-\u036f]/g, '') // Aksanları kaldır
                .replace(/ç/g, 'c')
                .replace(/ğ/g, 'g')
                .replace(/ı/g, 'i')
                .replace(/ö/g, 'o')
                .replace(/ş/g, 's')
                .replace(/ü/g, 'u')
                .trim();
        }
        
        // CSV dosyasını test et
        async function testCSVData() {
            const resultDiv = document.getElementById('csv-results');
            resultDiv.innerHTML = '⏳ CSV dosyası yükleniyor...';
            
            try {
                const response = await fetch('http://localhost:3000/merkez_koordinatlar.csv');
                const csvText = await response.text();
                
                if (!csvText) {
                    throw new Error('CSV dosyası boş');
                }
                
                // CSV'yi parse et
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',');
                
                csvData = lines.slice(1).map(line => {
                    const values = line.split(',');
                    return {
                        ilce: values[0],
                        tur: values[1],
                        ad: values[2],
                        dosya: values[3],
                        longitude: parseFloat(values[4]),
                        latitude: parseFloat(values[5])
                    };
                }).filter(item => item.longitude && item.latitude);
                
                let result = `✅ CSV başarıyla yüklendi!\n`;
                result += `📊 Toplam kayıt: ${csvData.length}\n`;
                result += `📍 İlçe sayısı: ${new Set(csvData.map(d => d.ilce)).size}\n`;
                result += `🏘️ Mahalle sayısı: ${csvData.filter(d => d.tur === 'MAHALLE').length}\n`;
                result += `🏢 İlçe merkezi sayısı: ${csvData.filter(d => d.tur === 'İLÇE').length}\n\n`;
                
                // İlk 5 kaydı göster
                result += `📋 İlk 5 kayıt:\n`;
                csvData.slice(0, 5).forEach((item, index) => {
                    result += `${index + 1}. ${item.tur}: ${item.ad}, ${item.ilce} (${item.latitude}, ${item.longitude})\n`;
                });
                
                resultDiv.innerHTML = result;
                resultDiv.className = 'result-box success';
                
            } catch (error) {
                resultDiv.innerHTML = `❌ CSV yükleme hatası: ${error.message}`;
                resultDiv.className = 'result-box error';
            }
        }
        
        // Konum parsing test et
        function testLocationParsing() {
            const resultDiv = document.getElementById('csv-results');
            
            if (csvData.length === 0) {
                resultDiv.innerHTML = '⚠️ Önce CSV dosyasını yükleyin!';
                return;
            }
            
            let result = `🔍 Parsing doğrulama sonuçları:\n\n`;
            
            // Koordinat aralığı kontrolü (İzmir için)
            const invalidCoords = csvData.filter(item => 
                item.latitude < 38.0 || item.latitude > 39.0 ||
                item.longitude < 26.0 || item.longitude > 28.0
            );
            
            if (invalidCoords.length > 0) {
                result += `⚠️ İzmir dışı koordinatlar (${invalidCoords.length} adet):\n`;
                invalidCoords.slice(0, 3).forEach(item => {
                    result += `- ${item.ad}, ${item.ilce}: ${item.latitude}, ${item.longitude}\n`;
                });
                result += '\n';
            } else {
                result += `✅ Tüm koordinatlar İzmir sınırları içinde\n\n`;
            }
            
            // Duplicate kontrol
            const seen = new Set();
            const duplicates = csvData.filter(item => {
                const key = `${item.ilce}-${item.ad}`;
                if (seen.has(key)) return true;
                seen.add(key);
                return false;
            });
            
            result += `🔄 Duplicate kayıt: ${duplicates.length} adet\n`;
            result += `📏 Ortalama enlem: ${(csvData.reduce((a, b) => a + b.latitude, 0) / csvData.length).toFixed(4)}\n`;
            result += `📏 Ortalama boylam: ${(csvData.reduce((a, b) => a + b.longitude, 0) / csvData.length).toFixed(4)}\n`;
            
            resultDiv.innerHTML = result;
        }
        
        // Arama algoritması test et
        function testSearchAlgorithm() {
            const resultDiv = document.getElementById('search-results');
            
            if (csvData.length === 0) {
                resultDiv.innerHTML = '⚠️ Önce CSV dosyasını yükleyin!';
                return;
            }
            
            const testQueries = ['kar', 'bor', 'kon', 'men', 'bay', 'çeş', 'ödemiş', 'güzelbahçe', 'bostanlı'];
            let result = `🔍 Arama algoritması test sonuçları (Türkçe karakter destekli):\n\n`;
            
            testQueries.forEach(query => {
                const startTime = performance.now();
                
                const filtered = csvData.filter(location => {
                    const normalizedSearchTerm = normalizeText(query);
                    const normalizedLocationName = normalizeText(location.ad);
                    const normalizedDistrictName = normalizeText(location.ilce);
                    
                    const nameMatch = normalizedLocationName.includes(normalizedSearchTerm);
                    const districtMatch = normalizedDistrictName.includes(normalizedSearchTerm);
                    
                    return nameMatch || districtMatch;
                }).slice(0, 5);
                
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                result += `"${query}" → ${filtered.length} sonuç (${duration}ms)\n`;
                filtered.forEach(item => {
                    result += `  - ${item.tur}: ${item.ad}, ${item.ilce}\n`;
                });
                result += '\n';
            });
            
            resultDiv.innerHTML = result;
        }
        
        // Performans testi
        function testPerformance() {
            const resultDiv = document.getElementById('search-results');
            
            if (csvData.length === 0) {
                resultDiv.innerHTML = '⚠️ Önce CSV dosyasını yükleyin!';
                return;
            }
            
            let result = `⚡ Performans test sonuçları:\n\n`;
            
            // 100 arama işlemi
            const queries = ['a', 'ka', 'kar', 'karş', 'karşı', 'karşıy', 'karşıya', 'karşıyak', 'karşıyaka'];
            const iterations = 100;
            
            const startTime = performance.now();
            
            for (let i = 0; i < iterations; i++) {
                queries.forEach(query => {
                    csvData.filter(location => {
                        const normalizedSearchTerm = normalizeText(query);
                        const normalizedLocationName = normalizeText(location.ad);
                        const normalizedDistrictName = normalizeText(location.ilce);
                        
                        const nameMatch = normalizedLocationName.includes(normalizedSearchTerm);
                        const districtMatch = normalizedDistrictName.includes(normalizedSearchTerm);
                        
                        return nameMatch || districtMatch;
                    }).slice(0, 10);
                });
            }
            
            const endTime = performance.now();
            const totalTime = endTime - startTime;
            const avgTime = totalTime / (iterations * queries.length);
            
            result += `🎯 ${iterations * queries.length} arama işlemi\n`;
            result += `⏱️ Toplam süre: ${totalTime.toFixed(2)}ms\n`;
            result += `📊 Ortalama arama süresi: ${avgTime.toFixed(3)}ms\n`;
            result += `🚀 Saniyede arama sayısı: ${(1000 / avgTime).toFixed(0)}\n\n`;
            
            if (avgTime < 1) {
                result += `✅ Performans mükemmel! (< 1ms)\n`;
            } else if (avgTime < 5) {
                result += `✅ Performans iyi! (< 5ms)\n`;
            } else {
                result += `⚠️ Performans optimizasyonu gerekebilir (> 5ms)\n`;
            }
            
            resultDiv.innerHTML = result;
        }
        
        // Koordinat doğrulama
        function testCoordinateValidation() {
            const resultDiv = document.getElementById('coordinate-results');
            
            if (csvData.length === 0) {
                resultDiv.innerHTML = '⚠️ Önce CSV dosyasını yükleyin!';
                return;
            }
            
            // Bazı bilinen konumları test et
            const knownLocations = [
                { name: 'KARŞIYAKA', expectedLat: 38.46, expectedLng: 27.10 },
                { name: 'BORNOVA', expectedLat: 38.47, expectedLng: 27.22 },
                { name: 'KONAK', expectedLat: 38.42, expectedLng: 27.14 }
            ];
            
            let result = `📍 Koordinat doğrulama sonuçları:\n\n`;
            
            knownLocations.forEach(known => {
                const found = csvData.find(item => 
                    item.ilce.includes(known.name) || item.ad.includes(known.name)
                );
                
                if (found) {
                    const latDiff = Math.abs(found.latitude - known.expectedLat);
                    const lngDiff = Math.abs(found.longitude - known.expectedLng);
                    
                    result += `🎯 ${known.name}:\n`;
                    result += `  Bulundu: ${found.ad}, ${found.ilce}\n`;
                    result += `  Koordinat: ${found.latitude}, ${found.longitude}\n`;
                    result += `  Beklenen: ${known.expectedLat}, ${known.expectedLng}\n`;
                    result += `  Fark: ${latDiff.toFixed(4)}, ${lngDiff.toFixed(4)}\n`;
                    
                    if (latDiff < 0.1 && lngDiff < 0.1) {
                        result += `  ✅ Koordinat doğru\n\n`;
                    } else {
                        result += `  ⚠️ Koordinat farkı büyük\n\n`;
                    }
                } else {
                    result += `❌ ${known.name} bulunamadı\n\n`;
                }
            });
            
            resultDiv.innerHTML = result;
        }
        
        // Zoom fonksiyonu test
        function testZoomFunctionality() {
            const resultDiv = document.getElementById('coordinate-results');
            
            let result = `🔍 Zoom fonksiyonu test sonuçları:\n\n`;
            
            // Test koordinatları
            const testCoords = [
                { name: 'İzmir Merkez', lat: 38.4237, lng: 27.1428, expectedZoom: 15 },
                { name: 'Karşıyaka', lat: 38.4667, lng: 27.1000, expectedZoom: 16 },
                { name: 'Bornova', lat: 38.4667, lng: 27.2167, expectedZoom: 16 }
            ];
            
            testCoords.forEach(coord => {
                result += `📍 ${coord.name} zoom testi:\n`;
                result += `  Koordinat: ${coord.lat}, ${coord.lng}\n`;
                result += `  Zoom seviyesi: ${coord.expectedZoom}\n`;
                result += `  ✅ Zoom fonksiyonu çağrılabilir\n\n`;
            });
            
            result += `💡 Gerçek zoom testi React sayfasında yapılmalıdır.\n`;
            result += `🔗 http://localhost:3000/bag-evi sayfasını ziyaret edin.\n`;
            
            resultDiv.innerHTML = result;
        }
        
        // React entegrasyon testi
        function testReactIntegration() {
            const resultDiv = document.getElementById('react-results');
            
            let result = `⚛️ React entegrasyon kontrol listesi:\n\n`;
            
            // Dosya varlık kontrolü
            const requiredFiles = [
                '/merkez_koordinatlar.csv',
                // React build dosyaları runtime'da kontrol edilebilir
            ];
            
            result += `📁 Gerekli dosyalar:\n`;
            result += `  ✅ merkez_koordinatlar.csv (public klasöründe)\n`;
            result += `  ✅ LocationAutocomplete.tsx (components klasöründe)\n`;
            result += `  ✅ MapComponent.tsx (güncellendi)\n`;
            result += `  ✅ CalculationPage.tsx (güncellendi)\n\n`;
            
            result += `🔧 Entegrasyon adımları:\n`;
            result += `  ✅ CSV dosyası kopyalandı\n`;
            result += `  ✅ LocationAutocomplete komponenti oluşturuldu\n`;
            result += `  ✅ MapComponent'e zoom fonksiyonu eklendi\n`;
            result += `  ✅ CalculationPage'e autocomplete entegre edildi\n\n`;
            
            result += `🎯 Test senaryoları:\n`;
            result += `  1. Arama kutusuna "kar" yazın → Karşıyaka çıkmalı\n`;
            result += `  2. Bir konum seçin → Harita zoom yapmalı\n`;
            result += `  3. Koordinat bilgisi güncellenip gösterilmeli\n`;
            result += `  4. Bağ evi formu normal çalışmalı\n\n`;
            
            result += `🚀 Test etmek için:\n`;
            result += `  → http://localhost:3000/bag-evi linkini kullanın\n`;
            
            resultDiv.innerHTML = result;
        }
        
        // Sayfa yüklendiğinde otomatik CSV test et
        window.onload = function() {
            testCSVData();
        };
    </script>
</body>
</html>
