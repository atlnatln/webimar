from django.shortcuts import render
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework import status
from rest_framework.permissions import IsAuthenticated
import logging
from django.utils.timezone import now

# Import hesaplama modÃ¼lleri
from .tarimsal_yapilar import (
    buyukbas, kucukbas, kanatli, hara, 
    aricilik, mantar_tesisi, sera, solucan_tesisi, ipek_bocekciligi,
    bag_evi, tarimsal_silo, lisansli_depo, evcil_hayvan, yikama_tesisi, kurutma_tesisi, meyve_sebze_kurutma, zeytinyagi_fabrikasi, su_depolama, su_kuyulari, zeytinyagi_uretim_tesisi, soguk_hava_deposu, tarimsal_amacli_depo, constants
)
from .models import CalculationHistory

logger = logging.getLogger('calculations')

@api_view(['GET'])
def health_check(request):
    """Calculations app health check endpoint"""
    return Response({
        'status': 'ok',
        'app': 'calculations',
        'message': 'Calculations app is running successfully'
    })

# HayvancÄ±lÄ±k Tesisleri API Endpoints

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_hara(request):
    """At yetiÅŸtiriciliÄŸi tesisi (hara) hesaplamasÄ± (ID: 24)"""
    try:
        logger.info(f"[HARA] API request.data: {request.data}")
        emsal_orani = request.data.get('emsal_orani')
        logger.info(f"[HARA] emsal_orani: {emsal_orani}")
        alan_m2 = request.data.get('alan_m2')
        arazi_vasfi = request.data.get('arazi_vasfi', 'Dikili tarÄ±m')
        logger.info(f"[HARA] alan_m2: {alan_m2}, arazi_vasfi: {arazi_vasfi}")
        if alan_m2 is not None:
            arazi_bilgileri = {
                'alan_m2': float(alan_m2),
                'buyukluk_m2': float(alan_m2),
                'arazi_vasfi': arazi_vasfi
            }
            yapi_bilgileri = {}
        else:
            arazi_bilgileri = request.data.get('arazi_bilgileri', {})
            yapi_bilgileri = request.data.get('yapi_bilgileri', {})
        logger.info(f"[HARA] arazi_bilgileri: {arazi_bilgileri}, yapi_bilgileri: {yapi_bilgileri}")
        result = hara.hara_tesisi_degerlendir(arazi_bilgileri, yapi_bilgileri, emsal_orani)
        logger.info(f"[HARA] result: {result}")
        # Hesaplama geÃ§miÅŸine kaydet (ana akÄ±ÅŸÄ± bozmaz)
        try:
            CalculationHistory.objects.create(
                user=request.user,
                calculation_type='Hara Tesisi',
                parameters=dict(request.data),
                result=result if isinstance(result, dict) else {'result': str(result)},
                created_at=now()
            )
        except Exception as log_err:
            logger.error(f"[HARA] CalculationHistory kayÄ±t hatasÄ±: {log_err}")
        return Response({
            'success': True,
            'results': result,
            'message': 'Hara tesisi hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"[HARA] calculation error: {str(e)}", exc_info=True)
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Hara tesisi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_evcil_hayvan(request):
    """Evcil hayvan ve bilimsel araÅŸtÄ±rma hayvanÄ± Ã¼retim tesisi hesaplamasÄ± (ID: 26)"""
    try:
        logger.info(f"Evcil hayvan calculation request: {request.data}")
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        logger.info(f"Extracted emsal_orani: {emsal_orani}")
        
        # Frontend'den gelen veri yapÄ±sÄ±nÄ± backend beklentisine uyarla
        alan_m2 = request.data.get('alan_m2')
        arazi_vasfi = request.data.get('arazi_vasfi', 'Dikili tarÄ±m')
        su_tahsis_belgesi = request.data.get('su_tahsis_belgesi', False)
        yas_kapali_alan_durumu = request.data.get('yas_kapali_alan_durumu', 'dÄ±ÅŸÄ±nda')
        
        # Frontend veri yapÄ±sÄ±nÄ± kontrol et
        if alan_m2 is not None:
            # Frontend formatÄ±ndan backend formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
            arazi_bilgileri = {
                'buyukluk_m2': float(alan_m2),
                'arazi_vasfi': arazi_vasfi,
                'su_tahsis_belgesi': str(su_tahsis_belgesi).lower(),
                'yas_kapali_alan_durumu': yas_kapali_alan_durumu
            }
            yapi_bilgileri = {}
        else:
            # Eski format desteÄŸi
            arazi_bilgileri = request.data.get('arazi_bilgileri', {})
            yapi_bilgileri = request.data.get('yapi_bilgileri', {})
        
        result = evcil_hayvan.evcil_hayvan_tesisi_degerlendir(arazi_bilgileri, yapi_bilgileri, emsal_orani)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'Evcil hayvan tesisi hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Evcil hayvan calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Evcil hayvan tesisi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_ipek_bocekciligi(request):
    """Ä°pek bÃ¶cekÃ§iliÄŸi hesaplamasÄ± (ID: 25)"""
    try:
        logger.info(f"Ipek bocekciligi calculation request: {request.data}")
        
        # Frontend'den gelen veri yapÄ±sÄ±nÄ± backend beklentisine uyarla
        alan_m2 = request.data.get('alan_m2')
        dut_bahcesi_var_mi = request.data.get('dut_bahcesi_var_mi', True)
        arazi_vasfi = request.data.get('arazi_vasfi', 'Dikili tarÄ±m')
        genel_emsal_orani = request.data.get('genel_emsal_orani', 0.20)
        
        # Frontend veri yapÄ±sÄ±nÄ± kontrol et
        if alan_m2 is not None:
            # Frontend formatÄ±ndan backend formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
            arazi_bilgileri = {
                'alan_m2': float(alan_m2),
                'buyukluk_m2': float(alan_m2),  # hem alan_m2 hem buyukluk_m2 desteÄŸi
                'arazi_vasfi': arazi_vasfi
            }
            yapi_bilgileri = {
                'dut_bahcesi_var_mi': dut_bahcesi_var_mi  # dut_bahcesi_var_mi yapi_bilgileri iÃ§inde olmalÄ±
            }
        else:
            # Eski format desteÄŸi
            arazi_bilgileri = request.data.get('arazi_bilgileri', {})
            yapi_bilgileri = request.data.get('yapi_bilgileri', {})
        
        result = ipek_bocekciligi.hesapla_ipek_bocekciligi_kurallari(arazi_bilgileri, yapi_bilgileri, genel_emsal_orani)
        
        return Response({
            'success': True,
            'sonuc': result,  # Frontend'in beklediÄŸi 'sonuc' field'Ä±
            'message': 'Ä°pek bÃ¶cekÃ§iliÄŸi hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Ipek bocekciligi calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Ä°pek bÃ¶cekÃ§iliÄŸi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

# HayvancÄ±lÄ±k Tesisleri Endpoints (ID'lere gÃ¶re)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_sut_sigirciligi(request):
    """SÃ¼t sÄ±ÄŸÄ±rcÄ±lÄ±ÄŸÄ± hesaplamasÄ± (ID: 17)"""
    try:
        logger.info(f"Sut sigirciligi calculation request: {request.data}")
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        logger.info(f"Extracted emsal_orani: {emsal_orani}")
        
        # Parametreleri Ã§Ä±kar - hem alan_m2 hem de buyukluk_m2 destekle
        alan_m2 = request.data.get('alan_m2')
        alan = request.data.get('alan')
        arazi_buyuklugu_m2 = request.data.get('arazi_buyuklugu_m2')
        buyukluk_m2 = request.data.get('buyukluk_m2')
        
        # Alan parametresini standartlaÅŸtÄ±r
        if alan_m2:
            arazi_alani = float(alan_m2)
        elif alan:
            arazi_alani = float(alan)
        elif arazi_buyuklugu_m2:
            arazi_alani = float(arazi_buyuklugu_m2)
        elif buyukluk_m2:
            arazi_alani = float(buyukluk_m2)
        else:
            # Eski format iÃ§in fallback
            arazi_bilgileri = request.data.get('arazi_bilgileri', {})
            yapi_bilgileri = request.data.get('yapi_bilgileri', {})
            
            result = buyukbas.sut_sigiri_degerlendir(arazi_bilgileri, yapi_bilgileri, emsal_orani)
            
            return Response({
                'success': True,
                'results': result,
                'message': 'SÃ¼t sÄ±ÄŸÄ±rcÄ±lÄ±ÄŸÄ± hesaplama baÅŸarÄ±yla tamamlandÄ±'
            })
        
        # Yeni format: arazi_bilgileri ve yapi_bilgileri structure'Ä±nÄ± oluÅŸtur
        arazi_bilgileri = {'buyukluk_m2': arazi_alani}
        yapi_bilgileri = {}
        
        result = buyukbas.sut_sigiri_degerlendir(arazi_bilgileri, yapi_bilgileri, emsal_orani)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'SÃ¼t sÄ±ÄŸÄ±rcÄ±lÄ±ÄŸÄ± hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Sut sigirciligi calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'SÃ¼t sÄ±ÄŸÄ±rcÄ±lÄ±ÄŸÄ± hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_besi_sigirciligi(request):
    """Besi sÄ±ÄŸÄ±rcÄ±lÄ±ÄŸÄ± hesaplamasÄ± (ID: 27)"""
    try:
        logger.info(f"Besi sigirciligi calculation request: {request.data}")
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        logger.info(f"Extracted emsal_orani: {emsal_orani}")
        
        # Parametreleri Ã§Ä±kar - hem alan_m2 hem de buyukluk_m2 destekle
        alan_m2 = request.data.get('alan_m2')
        alan = request.data.get('alan')
        arazi_buyuklugu_m2 = request.data.get('arazi_buyuklugu_m2')
        buyukluk_m2 = request.data.get('buyukluk_m2')
        
        # Alan parametresini standartlaÅŸtÄ±r
        if alan_m2:
            arazi_alani = float(alan_m2)
        elif alan:
            arazi_alani = float(alan)
        elif arazi_buyuklugu_m2:
            arazi_alani = float(arazi_buyuklugu_m2)
        elif buyukluk_m2:
            arazi_alani = float(buyukluk_m2)
        else:
            # Eski format iÃ§in fallback
            arazi_bilgileri = request.data.get('arazi_bilgileri', {})
            yapi_bilgileri = request.data.get('yapi_bilgileri', {})
            
            result = buyukbas.besi_sigiri_degerlendir(arazi_bilgileri, yapi_bilgileri, emsal_orani)
            
            return Response({
                'success': True,
                'results': result,
                'message': 'Besi sÄ±ÄŸÄ±rcÄ±lÄ±ÄŸÄ± hesaplama baÅŸarÄ±yla tamamlandÄ±'
            })
        
        # Yeni format: arazi_bilgileri ve yapi_bilgileri structure'Ä±nÄ± oluÅŸtur
        arazi_bilgileri = {'buyukluk_m2': arazi_alani}
        yapi_bilgileri = {}
        
        result = buyukbas.besi_sigiri_degerlendir(arazi_bilgileri, yapi_bilgileri, emsal_orani)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'Besi sÄ±ÄŸÄ±rcÄ±lÄ±ÄŸÄ± hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Besi sigirciligi calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Besi sÄ±ÄŸÄ±rcÄ±lÄ±ÄŸÄ± hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_agil_kucukbas(request):
    """AÄŸÄ±l (kÃ¼Ã§Ã¼kbaÅŸ hayvan barÄ±naÄŸÄ±) hesaplamasÄ± (ID: 18)"""
    try:
        logger.info(f"Agil kucukbas calculation request: {request.data}")
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        logger.info(f"Extracted emsal_orani: {emsal_orani}")
        
        # Parametreleri Ã§Ä±kar - hem alan_m2 hem de buyukluk_m2 destekle
        alan_m2 = request.data.get('alan_m2')
        alan = request.data.get('alan')
        arazi_buyuklugu_m2 = request.data.get('arazi_buyuklugu_m2')
        buyukluk_m2 = request.data.get('buyukluk_m2')
        
        # Alan parametresini standartlaÅŸtÄ±r
        if alan_m2:
            arazi_alani = float(alan_m2)
        elif alan:
            arazi_alani = float(alan)
        elif arazi_buyuklugu_m2:
            arazi_alani = float(arazi_buyuklugu_m2)
        elif buyukluk_m2:
            arazi_alani = float(buyukluk_m2)
        else:
            # Eski format iÃ§in fallback
            arazi_bilgileri = request.data.get('arazi_bilgileri', {})
            yapi_bilgileri = request.data.get('yapi_bilgileri', {})
            
            result = kucukbas.kucukbas_degerlendir(arazi_bilgileri, yapi_bilgileri, emsal_orani)
            
            return Response({
                'success': True,
                'results': result,
                'message': 'AÄŸÄ±l hesaplama baÅŸarÄ±yla tamamlandÄ±'
            })
        
        # Yeni format: arazi_bilgileri ve yapi_bilgileri structure'Ä±nÄ± oluÅŸtur
        arazi_bilgileri = {'buyukluk_m2': arazi_alani}
        yapi_bilgileri = {}
        
        result = kucukbas.kucukbas_degerlendir(arazi_bilgileri, yapi_bilgileri, emsal_orani)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'AÄŸÄ±l hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Agil kucukbas calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'AÄŸÄ±l hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_kumes_yumurtaci(request):
    """KÃ¼mes (yumurtacÄ± tavuk) hesaplamasÄ± (ID: 19)"""
    try:
        logger.info(f"Kumes yumurtaci calculation request: {request.data}")
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        logger.info(f"Extracted emsal_orani: {emsal_orani}")
        
        # Parametreleri Ã§Ä±kar - hem alan_m2 hem de alan destekle
        alan_m2 = request.data.get('alan_m2')
        alan = request.data.get('alan')
        arazi_buyuklugu_m2 = request.data.get('arazi_buyuklugu_m2')
        
        # Alan parametresini standartlaÅŸtÄ±r
        if alan_m2:
            arazi_alani = float(alan_m2)
        elif alan:
            arazi_alani = float(alan)
        elif arazi_buyuklugu_m2:
            arazi_alani = float(arazi_buyuklugu_m2)
        else:
            return Response({
                'success': False,
                'message': 'alan_m2, alan veya arazi_buyuklugu_m2 parametresi gereklidir',
                'data': None
            }, status=status.HTTP_400_BAD_REQUEST)
        
        if arazi_alani <= 0:
            return Response({
                'success': False,
                'message': 'Alan 0\'dan bÃ¼yÃ¼k olmalÄ±dÄ±r',
                'data': None
            }, status=status.HTTP_400_BAD_REQUEST)
        
        result = kanatli.yumurtaci_tavuk_degerlendir(arazi_alani, emsal_orani=emsal_orani)
        
        return Response({
            'success': True,
            'message': 'YumurtacÄ± tavuk kÃ¼mesi hesaplama baÅŸarÄ±yla tamamlandÄ±',
            'data': result
        })
    except Exception as e:
        return Response({
            'success': False,
            'error': str(e),
            'message': 'YumurtacÄ± tavuk kÃ¼mesi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_kumes_etci(request):
    """KÃ¼mes (etÃ§i tavuk) hesaplamasÄ± (ID: 20)"""
    try:
        logger.info(f"Kumes etci calculation request: {request.data}")
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        logger.info(f"Extracted emsal_orani: {emsal_orani}")
        
        # Parametreleri Ã§Ä±kar - hem alan_m2 hem de alan destekle
        alan_m2 = request.data.get('alan_m2')
        alan = request.data.get('alan')
        arazi_buyuklugu_m2 = request.data.get('arazi_buyuklugu_m2')
        
        # Alan parametresini standartlaÅŸtÄ±r
        if alan_m2:
            arazi_alani = float(alan_m2)
        elif alan:
            arazi_alani = float(alan)
        elif arazi_buyuklugu_m2:
            arazi_alani = float(arazi_buyuklugu_m2)
        else:
            return Response({
                'success': False,
                'message': 'alan_m2, alan veya arazi_buyuklugu_m2 parametresi gereklidir',
                'data': None
            }, status=status.HTTP_400_BAD_REQUEST)
        
        if arazi_alani <= 0:
            return Response({
                'success': False,
                'message': 'Alan 0\'dan bÃ¼yÃ¼k olmalÄ±dÄ±r',
                'data': None
            }, status=status.HTTP_400_BAD_REQUEST)
        
        result = kanatli.etci_tavuk_degerlendir(arazi_alani, emsal_orani=emsal_orani)
        
        return Response({
            'success': True,
            'message': 'EtÃ§i tavuk kÃ¼mesi hesaplama baÅŸarÄ±yla tamamlandÄ±',
            'data': result
        })
    except Exception as e:
        return Response({
            'success': False,
            'error': str(e),
            'message': 'EtÃ§i tavuk kÃ¼mesi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_kumes_gezen(request):
    """KÃ¼mes (gezen tavuk) hesaplamasÄ± (ID: 21)"""
    try:
        logger.info(f"Kumes gezen calculation request: {request.data}")
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        logger.info(f"Extracted emsal_orani: {emsal_orani}")
        
        # Parametreleri Ã§Ä±kar - hem alan_m2 hem de nested structure destekle
        alan_m2 = request.data.get('alan_m2')
        alan = request.data.get('alan')
        arazi_buyuklugu_m2 = request.data.get('arazi_buyuklugu_m2')
        
        # Alan parametresini standartlaÅŸtÄ±r
        if alan_m2:
            arazi_alani = float(alan_m2)
            arazi_bilgileri = {'buyukluk_m2': arazi_alani}
            yapi_bilgileri = {}
        elif alan:
            arazi_alani = float(alan)
            arazi_bilgileri = {'buyukluk_m2': arazi_alani}
            yapi_bilgileri = {}
        elif arazi_buyuklugu_m2:
            arazi_alani = float(arazi_buyuklugu_m2)
            arazi_bilgileri = {'buyukluk_m2': arazi_alani}
            yapi_bilgileri = {}
        else:
            # Eski format iÃ§in fallback
            arazi_bilgileri = request.data.get('arazi_bilgileri', {})
            yapi_bilgileri = request.data.get('yapi_bilgileri', {})
        
        result = kanatli.gezen_tavuk_degerlendir(arazi_alani, emsal_orani=emsal_orani)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'Gezen tavuk kÃ¼mes hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Kumes gezen calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Gezen tavuk kÃ¼mes hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_kumes_hindi(request):
    """KÃ¼mes (hindi) hesaplamasÄ± (ID: 22)"""
    try:
        logger.info(f"Kumes hindi calculation request: {request.data}")
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        logger.info(f"Extracted emsal_orani: {emsal_orani}")
        
        # Parametreleri Ã§Ä±kar - hem alan_m2 hem de nested structure destekle
        alan_m2 = request.data.get('alan_m2')
        alan = request.data.get('alan')
        arazi_buyuklugu_m2 = request.data.get('arazi_buyuklugu_m2')
        
        # Alan parametresini standartlaÅŸtÄ±r
        if alan_m2:
            arazi_alani = float(alan_m2)
            arazi_bilgileri = {'buyukluk_m2': arazi_alani}
            yapi_bilgileri = {}
        elif alan:
            arazi_alani = float(alan)
            arazi_bilgileri = {'buyukluk_m2': arazi_alani}
            yapi_bilgileri = {}
        elif arazi_buyuklugu_m2:
            arazi_alani = float(arazi_buyuklugu_m2)
            arazi_bilgileri = {'buyukluk_m2': arazi_alani}
            yapi_bilgileri = {}
        else:
            # Eski format iÃ§in fallback
            arazi_bilgileri = request.data.get('arazi_bilgileri', {})
            yapi_bilgileri = request.data.get('yapi_bilgileri', {})
        
        result = kanatli.hindi_degerlendir(arazi_alani, emsal_orani=emsal_orani)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'Hindi kÃ¼mes hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Kumes hindi calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Hindi kÃ¼mes hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_kaz_ordek(request):
    """Kaz Ã–rdek Ã§iftliÄŸi hesaplamasÄ± (ID: 23)"""
    try:
        logger.info(f"Kaz ordek calculation request: {request.data}")
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        logger.info(f"Extracted emsal_orani: {emsal_orani}")
        
        # Parametreleri Ã§Ä±kar - hem alan_m2 hem de nested structure destekle
        alan_m2 = request.data.get('alan_m2')
        alan = request.data.get('alan')
        arazi_buyuklugu_m2 = request.data.get('arazi_buyuklugu_m2')
        
        # Alan parametresini standartlaÅŸtÄ±r
        if alan_m2:
            arazi_alani = float(alan_m2)
        elif alan:
            arazi_alani = float(alan)
        elif arazi_buyuklugu_m2:
            arazi_alani = float(arazi_buyuklugu_m2)
        else:
            # Eski format iÃ§in fallback
            arazi_bilgileri = request.data.get('arazi_bilgileri', {})
            arazi_alani = arazi_bilgileri.get('buyukluk_m2', 0)
            if arazi_alani == 0:
                return Response({
                    'success': False,
                    'error': 'alan_m2, alan veya arazi_buyuklugu_m2 parametresi gereklidir',
                    'message': 'Alan bilgisi gereklidir'
                }, status=status.HTTP_400_BAD_REQUEST)
        
        result = kanatli.kaz_ordek_degerlendir(arazi_alani, emsal_orani=emsal_orani)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'Kaz Ã¶rdek Ã§iftliÄŸi hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Kaz ordek calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Kaz Ã¶rdek Ã§iftliÄŸi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

# Depolama ve Ä°ÅŸleme Tesisleri iÃ§in eksik endpoint'ler (ID: 1-16)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_solucan_tesisi(request):
    """Solucan tesisi hesaplamasÄ± (ID: 1)"""
    try:
        logger.info(f"Solucan tesisi calculation request: {request.data}")
        
        # Use request.data directly as solucan_degerlendir expects
        result = solucan_tesisi.solucan_degerlendir(request.data)
        
        return Response(result)
    except Exception as e:
        logger.error(f"Solucan tesisi calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Solucan tesisi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_mantar_tesisi(request):
    """Mantar tesisi hesaplamasÄ± (ID: 2)"""
    try:
        logger.info(f"Mantar tesisi calculation request: {request.data}")
        
        # Use request.data directly as mantar_degerlendir expects
        result = mantar_tesisi.mantar_degerlendir(request.data)
        
        return Response(result)
    except Exception as e:
        logger.error(f"Mantar tesisi calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Mantar tesisi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_sera(request):
    """Sera hesaplamasÄ± (ID: 3)"""
    try:
        logger.info(f"Sera calculation request: {request.data}")
        
        # Frontend'den gelen veri yapÄ±sÄ±nÄ± backend beklentisine uyarla
        alan_m2 = request.data.get('alan_m2')
        arazi_vasfi = request.data.get('arazi_vasfi', 'TA')
        sera_alani_m2 = request.data.get('sera_alani_m2')
        
        # Frontend veri yapÄ±sÄ±nÄ± kontrol et
        if alan_m2 is not None:
            # Frontend formatÄ±ndan backend formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
            adapted_data = {
                'arazi_buyuklugu_m2': float(alan_m2),
                'arazi_vasfi': arazi_vasfi
            }
            # Sera alanÄ± belirtilmiÅŸse ekle, yoksa backend varsayÄ±lan %80 kullanacak
            if sera_alani_m2 is not None:
                adapted_data['sera_alani_m2'] = float(sera_alani_m2)
        else:
            # Eski format desteÄŸi
            adapted_data = request.data
        
        result = sera.sera_degerlendir(adapted_data)
        
        return Response(result)
    except Exception as e:
        logger.error(f"Sera calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Sera hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_aricilik(request):
    """ArÄ±cÄ±lÄ±k tesisi hesaplamasÄ± (ID: 4)"""
    try:
        logger.info(f"Aricilik calculation request: {request.data}")
        
        # Use request.data directly as aricilik_frontend_degerlendir expects
        result = aricilik.aricilik_frontend_degerlendir(request.data)
        
        return Response(result)
    except Exception as e:
        logger.error(f"Aricilik calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'ArÄ±cÄ±lÄ±k tesisi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_hububat_silo(request):
    """Hububat silo hesaplamasÄ± (ID: 5)"""
    try:
        logger.info(f"Hububat silo calculation request: {request.data}")
        logger.info(f"Request data type: {type(request.data)}")
        logger.info(f"Request data keys: {list(request.data.keys()) if hasattr(request.data, 'keys') else 'No keys'}")
        
        # Frontend'den gelen parametreleri al
        alan_m2 = request.data.get('alan_m2') or request.data.get('alan', 0)
        silo_taban_alani_m2 = request.data.get('silo_taban_alani_m2', 0)
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        
        logger.info(f"Extracted values - alan_m2: {alan_m2} (type: {type(alan_m2)}), silo_taban_alani_m2: {silo_taban_alani_m2} (type: {type(silo_taban_alani_m2)}), emsal_orani: {emsal_orani}")
        
        # Parametreleri kontrol et
        if not alan_m2 or alan_m2 <= 0:
            logger.error(f"Alan_m2 validation failed: {alan_m2}")
            return Response({
                'success': False,
                'error': 'Arazi alanÄ± pozitif bir sayÄ± olmalÄ±dÄ±r',
                'message': 'Arazi alanÄ± pozitif bir sayÄ± olmalÄ±dÄ±r'
            }, status=status.HTTP_400_BAD_REQUEST)
            
        if not silo_taban_alani_m2 or silo_taban_alani_m2 <= 0:
            return Response({
                'success': False,
                'error': 'Planlanan silo taban alanÄ± pozitif bir sayÄ± olmalÄ±dÄ±r',
                'message': 'Planlanan silo taban alanÄ± pozitif bir sayÄ± olmalÄ±dÄ±r'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        # API iÃ§in hububat_silo_degerlendir fonksiyonunu Ã§aÄŸÄ±r (dinamik emsal ile)
        result = tarimsal_silo.hububat_silo_degerlendir({
            'arazi_buyuklugu_m2': float(alan_m2),
            'silo_taban_alani_m2': float(silo_taban_alani_m2)
        }, emsal_orani=emsal_orani)
        
        
        return Response({
            'success': True,
            'results': result,
            'message': 'Hububat silo hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
        
    except Exception as e:
        logger.error(f"Hububat silo calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Hububat silo hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_lisansli_depo(request):
    """LisanslÄ± depo hesaplamasÄ± (ID: 7)"""
    try:
        logger.info(f"Lisansli depo calculation request: {request.data}")
        
        # PHASE 2 DÄ°NAMÄ°K EMSAL SÄ°STEMÄ° - emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        logger.info(f"Extracted emsal_orani: {emsal_orani}")
        
        result = lisansli_depo.lisansli_depo_degerlendir_api(request.data, emsal_orani)
        
        if result['success']:
            logger.info(f"Lisansli depo calculation successful")
            return Response({
                'success': True,
                'message': 'LisanslÄ± depo hesaplama baÅŸarÄ±yla tamamlandÄ±.',
                'data': {
                    'arazi_alani': result['arazi_buyuklugu_m2'],
                    'depo_alani': result.get('depo_taban_alani_m2', 0),
                    'maksimum_emsal': result['maksimum_emsal_alani_m2'],
                    'emsal_orani': f"{result['emsal_orani']*100:.0f}%",
                    'kalan_emsal': result['kalan_emsal_hakki_m2'],
                    'izin_durumu': result['izin_durumu'],
                    'html_mesaj': result.get('html_mesaj', ''),
                    'mesaj': result.get('html_mesaj', '')  # Frontend iÃ§in hem html_mesaj hem mesaj
                }
            })
        else:
            logger.warning(f"Lisansli depo calculation failed: {result['error']}")
            return Response({
                'success': False,
                'message': result['error'],
                'data': None
            }, status=status.HTTP_400_BAD_REQUEST)
            
    except Exception as e:
        logger.error(f"Lisansli depo calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'LisanslÄ± depo hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_yikama_tesisi(request):
    """YÄ±kama tesisi hesaplamasÄ± (ID: 8)"""
    try:
        logger.info(f"Yikama tesisi calculation request: {request.data}")
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        
        result = yikama_tesisi.yikama_tesisi_degerlendir(request.data, emsal_orani=emsal_orani)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'YÄ±kama tesisi hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Yikama tesisi calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'YÄ±kama tesisi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_kurutma_tesisi(request):
    """Kurutma tesisi hesaplamasÄ± (ID: 9)"""
    try:
        logger.info(f"Kurutma tesisi calculation request: {request.data}")
        
        # Frontend'den gelen veri yapÄ±sÄ±nÄ± backend beklentisine uyarla
        alan_m2 = request.data.get('alan_m2')
        
        # Frontend veri yapÄ±sÄ±nÄ± kontrol et
        if alan_m2 is not None:
            # Frontend formatÄ±ndan backend formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
            adapted_data = request.data.copy()
            adapted_data['arazi_buyuklugu_m2'] = float(alan_m2)
            # Eski alan_m2'yi kaldÄ±rmamÄ±za gerek yok, backend onu gÃ¶rmezden gelir
        else:
            # Eski format desteÄŸi
            adapted_data = request.data
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        
        result = kurutma_tesisi.kurutma_tesisi_degerlendir(adapted_data, emsal_orani=emsal_orani)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'Kurutma tesisi hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Kurutma tesisi calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Kurutma tesisi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_meyve_sebze_kurutma(request):
    """Meyve sebze kurutma alanÄ± hesaplamasÄ± (ID: 10)"""
    try:
        logger.info(f"Meyve sebze kurutma calculation request: {request.data}")
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        
        result = meyve_sebze_kurutma.meyve_sebze_kurutma_degerlendir(request.data, emsal_orani=emsal_orani)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'Meyve/sebze kurutma alanÄ± hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Meyve sebze kurutma calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Meyve/sebze kurutma alanÄ± hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_zeytinyagi_fabrikasi(request):
    """ZeytinyaÄŸÄ± fabrikasÄ± hesaplamasÄ± (ID: 11)"""
    try:
        logger.info(f"Zeytinyagi fabrikasi calculation request: {request.data}")
        
        # ZeytinyaÄŸÄ± fabrikasÄ± hesaplamasÄ±
        result = zeytinyagi_fabrikasi.zeytinyagi_fabrikasi_degerlendir(request.data)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'ZeytinyaÄŸÄ± fabrikasÄ± hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Zeytinyagi fabrikasi calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'ZeytinyaÄŸÄ± fabrikasÄ± hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_su_depolama(request):
    """Su depolama tesisi hesaplamasÄ± (ID: 12)"""
    try:
        logger.info(f"Su depolama calculation request: {request.data}")
        
        # Dinamik emsal desteÄŸi - frontend'den gelen emsal_orani parametresini al
        emsal_orani = request.data.get('emsal_orani')
        
        # Su depolama tesisi hesaplamasÄ±
        result = su_depolama.su_depolama_degerlendir(request.data, emsal_orani=emsal_orani)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'Su depolama tesisi hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Su depolama calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Su depolama tesisi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_su_kuyulari(request):
    """Su kuyularÄ± hesaplamasÄ± (ID: 13)"""
    try:
        logger.info(f"Su kuyulari calculation request: {request.data}")
        
        # Su kuyularÄ± hesaplamasÄ±
        result = su_kuyulari.su_kuyulari_degerlendir(request.data)
        
        return Response({
            'success': True,
            'results': result,
            'message': 'Su kuyularÄ± hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Su kuyulari calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Su kuyularÄ± hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_zeytinyagi_uretim_tesisi(request):
    """ZeytinyaÄŸÄ± Ã¼retim tesisi hesaplamasÄ± (ID: 15)"""
    try:
        logger.info(f"Zeytinyagi uretim tesisi calculation request: {request.data}")
        
        # Parametreleri Ã§Ä±kar
        alan_m2 = request.data.get('alan_m2')
        arazi_buyuklugu_m2 = request.data.get('arazi_buyuklugu_m2')
        
        # Alan parametresini standartlaÅŸtÄ±r
        if alan_m2:
            arazi_alani = float(alan_m2)
        elif arazi_buyuklugu_m2:
            arazi_alani = float(arazi_buyuklugu_m2)
        else:
            raise ValueError("alan_m2 veya arazi_buyuklugu_m2 parametresi gereklidir")
        
        # Hesaplama yap
        result = zeytinyagi_uretim_tesisi.zeytinyagi_uretim_tesisi_hesapla(arazi_alani)
        
        if result['success']:
            logger.info(f"Zeytinyagi uretim tesisi calculation successful")
            return Response({
                'success': True,
                'message': 'ZeytinyaÄŸÄ± Ã¼retim tesisi hesaplama baÅŸarÄ±yla tamamlandÄ±.',
                'data': {
                    'izin_durumu': result['izin_durumu'],
                    'arazi_alani': result['arazi_alani_m2'],
                    'emsal_orani': f"{result['emsal_orani']*100:.0f}%",
                    'maksimum_emsal_alani': result['maksimum_emsal_alani_m2'],
                    'uretim_alani': result['uretim_alani_m2'],
                    'idari_alan': result['idari_alan_m2'],
                    'yardimci_alan': result['yardimci_alan_m2'],
                    'toplam_insaat_alani': result['toplam_insaat_alani_m2'],
                    'kalan_emsal_hakki': result['kalan_emsal_hakki_m2'],
                    'emsal_kullanim_orani': result['emsal_kullanim_orani'],
                    'html_mesaj': f"""
                    <div class="calculation-result">
                        <h3 style="color: #2d5016;">ğŸ­ ZeytinyaÄŸÄ± Ãœretim Tesisi DeÄŸerlendirme Sonucu</h3>
                        <div class="result-item"><strong>ğŸ“ Arazi AlanÄ±:</strong> {result['arazi_alani_m2']:,.0f} mÂ²</div>
                        <div class="result-item"><strong>ğŸ“ Emsal OranÄ±:</strong> %{result['emsal_orani']*100:.0f}</div>
                        <div class="result-item"><strong>ğŸ—ï¸ Maksimum Emsal AlanÄ±:</strong> {result['maksimum_emsal_alani_m2']:,.1f} mÂ²</div>
                        <div class="result-item"><strong>ğŸ­ Ãœretim AlanÄ±:</strong> {result['uretim_alani_m2']:,.1f} mÂ²</div>
                        <div class="result-item"><strong>ğŸ¢ Ä°dari Alan:</strong> {result['idari_alan_m2']:,.1f} mÂ²</div>
                        <div class="result-item"><strong>ğŸ”§ YardÄ±mcÄ± Alan:</strong> {result['yardimci_alan_m2']:,.1f} mÂ²</div>
                        <div class="result-item"><strong>ğŸ“Š Toplam Ä°nÅŸaat AlanÄ±:</strong> {result['toplam_insaat_alani_m2']:,.1f} mÂ²</div>
                        <div class="result-item"><strong>ğŸ“ˆ Emsal KullanÄ±m OranÄ±:</strong> %{result['emsal_kullanim_orani']}</div>
                        <div class="result-item"><strong>ğŸ“‹ Kalan Emsal HakkÄ±:</strong> {result['kalan_emsal_hakki_m2']:,.1f} mÂ²</div>
                        <div class="result-status success"><strong>âœ… {result['izin_durumu']}</strong></div>
                    </div>
                    """
                }
            })
        else:
            logger.warning(f"Zeytinyagi uretim tesisi calculation failed: {result.get('error', 'Unknown error')}")
            return Response({
                'success': False,
                'message': result.get('error', 'Hesaplama baÅŸarÄ±sÄ±z'),
                'data': {
                    'izin_durumu': result.get('izin_durumu', 'HESAPLANAMADI'),
                    'html_mesaj': f"""
                    <div class="calculation-result">
                        <h3 style="color: #c41e3a;">ğŸš« ZeytinyaÄŸÄ± Ãœretim Tesisi DeÄŸerlendirme Sonucu</h3>
                        <div class="result-status error"><strong>âŒ {result.get('izin_durumu', 'TESÄ°S YAPILAMAZ')}</strong></div>
                        <div class="result-item"><strong>â— Hata:</strong> {result.get('error', 'Bilinmeyen hata')}</div>
                    </div>
                    """
                }
            })
            
    except Exception as e:
        logger.error(f"Zeytinyagi uretim tesisi calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'ZeytinyaÄŸÄ± Ã¼retim tesisi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_bag_evi(request):
    """BaÄŸ evi hesaplamasÄ± (ID: 14)"""
    try:
        logger.info(f"Bag evi calculation request: {request.data}")
        
        # Frontend'den gelen parametreleri al
        arazi_vasfi = request.data.get('arazi_vasfi', '')
        alan_m2 = request.data.get('alan_m2', 0)
        tarla_alani = request.data.get('tarla_alani', 0)
        dikili_alani = request.data.get('dikili_alani', 0)
        zeytinlik_alani = request.data.get('zeytinlik_alani', 0)  # Zeytinlik alanÄ± desteÄŸi eklendi
        zeytin_alani = request.data.get('zeytin_alani', 0)  # Frontend'den gelen zeytin aÄŸacÄ± sayÄ±sÄ±
        
        # "â€¦ Adetli Zeytin AÄŸacÄ± bulunan tarla" iÃ§in yeni alanlar
        tapu_zeytin_agac_adedi = request.data.get('tapu_zeytin_agac_adedi', 0)
        mevcut_zeytin_agac_adedi = request.data.get('mevcut_zeytin_agac_adedi', 0)
        
        # Zeytin aÄŸacÄ± adedi mapping - Ã¶nce request'ten al, yoksa mevcut_zeytin_agac_adedi'ni kullan, son Ã§are zeytin_alani
        zeytin_agac_adedi = request.data.get('zeytin_agac_adedi', 0) or mevcut_zeytin_agac_adedi or zeytin_alani
        
        logger.info(f"ğŸ«’ Adetli Zeytin mapping - Tapu: {tapu_zeytin_agac_adedi}, Mevcut: {mevcut_zeytin_agac_adedi}, KullanÄ±lan: {zeytin_agac_adedi}")
        
        # Frontend'den gelen manuel kontrol sonucu (manuel_kontrol_sonucu veya dikiliKontrolSonucu)
        manuel_kontrol_sonucu = request.data.get('manuel_kontrol_sonucu') or request.data.get('dikiliKontrolSonucu')
        bag_evi_var_mi = request.data.get('bag_evi_var_mi', False)
        
        # Frontend'den manuel kontrol sonucu geldi mi kontrol et ve logla
        if manuel_kontrol_sonucu:
            logger.info(f"ğŸ“Š Manuel kontrol sonucu alÄ±ndÄ±: {manuel_kontrol_sonucu}")
        
        # Debug: Gelen parametreleri logla
        logger.info(f"ğŸ” Parametreler - arazi_vasfi: {arazi_vasfi}, alan_m2: {alan_m2}")
        logger.info(f"ğŸ” Tarla alanÄ±: {tarla_alani}, Dikili alanÄ±: {dikili_alani}, Zeytinlik alanÄ±: {zeytinlik_alani}")
        
        # "Tarla + herhangi bir dikili vasÄ±flÄ±" Ã¶zel durumu
        if arazi_vasfi == "Tarla + herhangi bir dikili vasÄ±flÄ±":
            # Frontend'den gelen verilerle arazi bilgilerini oluÅŸtur
            toplam_arazi = tarla_alani + dikili_alani
            
            arazi_bilgileri = {
                'ana_vasif': arazi_vasfi,
                'buyukluk_m2': toplam_arazi,
                'buyuk_ova_icinde': False,  # Bu bilgi frontend'den gelebilir
                'tarla_alani': tarla_alani,
                'dikili_alani': dikili_alani
            }
            
            # Yeni ana hesaplama fonksiyonunu kullan - manuel kontrol sonucunu geÃ§ir
            result = bag_evi.hesapla(
                arazi_bilgileri, 
                {}, 
                bag_evi_var_mi, 
                manuel_kontrol_sonucu
            )
        elif arazi_vasfi == "Tarla + Zeytinlik":
            # "Tarla + Zeytinlik" Ã¶zel durumu iÃ§in yeni iÅŸleme
            toplam_arazi = tarla_alani + zeytinlik_alani
            
            arazi_bilgileri = {
                'ana_vasif': arazi_vasfi,
                'buyukluk_m2': toplam_arazi,
                'buyuk_ova_icinde': False,
                'tarla_alani': tarla_alani,
                'zeytinlik_alani': zeytinlik_alani
            }
            
            logger.info(f"ğŸ«’ Tarla + Zeytinlik hesaplama - Tarla: {tarla_alani}, Zeytinlik: {zeytinlik_alani}, Toplam: {toplam_arazi}")
            
            # Yeni ana hesaplama fonksiyonunu kullan
            result = bag_evi.hesapla(
                arazi_bilgileri, 
                {}, 
                bag_evi_var_mi, 
                manuel_kontrol_sonucu
            )
        elif arazi_vasfi == "â€¦ Adetli Zeytin AÄŸacÄ± bulunan tarla":
            # "â€¦ Adetli Zeytin AÄŸacÄ± bulunan tarla" Ã¶zel durumu iÃ§in yeni iÅŸleme
            arazi_bilgileri = {
                'ana_vasif': arazi_vasfi,
                'buyukluk_m2': alan_m2,
                'buyuk_ova_icinde': False,
                'tarla_alani': tarla_alani,
                'zeytin_agac_adedi': zeytin_agac_adedi,
                'tapu_zeytin_agac_adedi': tapu_zeytin_agac_adedi,
                'mevcut_zeytin_agac_adedi': mevcut_zeytin_agac_adedi
            }
            
            logger.info(f"ğŸ«’ Adetli Zeytin AÄŸacÄ± bulunan tarla hesaplama - Tarla: {tarla_alani}, Tapu aÄŸaÃ§: {tapu_zeytin_agac_adedi}, Mevcut aÄŸaÃ§: {mevcut_zeytin_agac_adedi}")
            
            # Universal fonksiyonu kullan
            result = bag_evi.bag_evi_universal_degerlendir(
                arazi_bilgileri, 
                {}, 
                bag_evi_var_mi, 
                manuel_kontrol_sonucu
            )
        elif arazi_vasfi == "â€¦ Adetli Zeytin AÄŸacÄ± bulunan + herhangi bir dikili vasÄ±f":
            # "â€¦ Adetli Zeytin AÄŸacÄ± bulunan + herhangi bir dikili vasÄ±f" Ã¶zel durumu iÃ§in yeni iÅŸleme
            
            # Manuel kontrol sonucundan alan deÄŸerlerini al (eÄŸer varsa)
            final_dikili_alani = dikili_alani
            if manuel_kontrol_sonucu and isinstance(manuel_kontrol_sonucu, dict):
                # DirectTransfer durumunda harita verilerini kullan
                if manuel_kontrol_sonucu.get('directTransfer'):
                    final_dikili_alani = manuel_kontrol_sonucu.get('dikiliAlan', dikili_alani)
                    logger.info(f"ğŸ—ºï¸ DirectTransfer dikili alan gÃ¼ncellendi: {dikili_alani} â†’ {final_dikili_alani}")
            
            arazi_bilgileri = {
                'ana_vasif': arazi_vasfi,
                'buyukluk_m2': final_dikili_alani,  # GÃ¼ncellenmiÅŸ dikili alan
                'buyuk_ova_icinde': False,
                'dikili_alani': final_dikili_alani,  # GÃ¼ncellenmiÅŸ dikili alan
                'zeytin_agac_adedi': zeytin_agac_adedi,
                'tapu_zeytin_agac_adedi': tapu_zeytin_agac_adedi,
                'mevcut_zeytin_agac_adedi': mevcut_zeytin_agac_adedi
            }
            
            logger.info(f"ğŸ«’ Adetli Zeytin AÄŸacÄ± bulunan + dikili vasÄ±f hesaplama - Dikili: {dikili_alani}, Tapu aÄŸaÃ§: {tapu_zeytin_agac_adedi}, Mevcut aÄŸaÃ§: {mevcut_zeytin_agac_adedi}")
            
            # Universal fonksiyonu kullan
            result = bag_evi.bag_evi_universal_degerlendir(
                arazi_bilgileri, 
                {}, 
                bag_evi_var_mi, 
                manuel_kontrol_sonucu
            )
        elif arazi_vasfi == "Zeytin aÄŸaÃ§lÄ± + tarla":
            # "Zeytin aÄŸaÃ§lÄ± + tarla" Ã¶zel durumu iÃ§in yeni iÅŸleme
            # Sadece tarla alanÄ± kullanÄ±lÄ±r, zeytin aÄŸacÄ± adedi kontrol edilir
            
            arazi_bilgileri = {
                'ana_vasif': arazi_vasfi,
                'buyukluk_m2': tarla_alani,  # Sadece tarla alanÄ±
                'buyuk_ova_icinde': False,
                'tarla_alani': tarla_alani,
                'zeytin_agac_adedi': zeytin_agac_adedi
            }
            
            logger.info(f"ğŸ«’ Zeytin aÄŸaÃ§lÄ± + tarla hesaplama - Tarla: {tarla_alani} mÂ², Zeytin aÄŸacÄ±: {zeytin_agac_adedi} adet")
            
            # Yeni ana hesaplama fonksiyonunu kullan
            result = bag_evi.hesapla(
                arazi_bilgileri, 
                {}, 
                bag_evi_var_mi, 
                manuel_kontrol_sonucu
            )
        elif arazi_vasfi == "Zeytin aÄŸaÃ§lÄ± + herhangi bir dikili vasÄ±f":
            # "Zeytin aÄŸaÃ§lÄ± + herhangi bir dikili vasÄ±f" Ã¶zel durumu iÃ§in yeni iÅŸleme
            # Dikili alan kullanÄ±lÄ±r, zeytin aÄŸacÄ± adedi kontrol edilir
            
            # Manuel kontrol sonucundan alan deÄŸerlerini al (eÄŸer varsa)
            final_dikili_alani = dikili_alani
            if manuel_kontrol_sonucu and isinstance(manuel_kontrol_sonucu, dict):
                # DirectTransfer durumunda harita verilerini kullan
                if manuel_kontrol_sonucu.get('directTransfer'):
                    final_dikili_alani = manuel_kontrol_sonucu.get('dikiliAlan', dikili_alani)
                    logger.info(f"ğŸ—ºï¸ DirectTransfer dikili alan gÃ¼ncellendi: {dikili_alani} â†’ {final_dikili_alani}")
            
            arazi_bilgileri = {
                'ana_vasif': arazi_vasfi,
                'buyukluk_m2': final_dikili_alani,  # GÃ¼ncellenmiÅŸ dikili alan 
                'buyuk_ova_icinde': False,
                'dikili_alani': final_dikili_alani,  # GÃ¼ncellenmiÅŸ dikili alan
                'zeytin_agac_adedi': zeytin_agac_adedi
            }
            
            logger.info(f"ğŸ«’ Zeytin aÄŸaÃ§lÄ± + dikili vasÄ±f hesaplama - Dikili alan: {dikili_alani} mÂ², Zeytin aÄŸacÄ±: {zeytin_agac_adedi} adet")
            
            # Yeni ana hesaplama fonksiyonunu kullan
            result = bag_evi.hesapla(
                arazi_bilgileri, 
                {}, 
                bag_evi_var_mi, 
                manuel_kontrol_sonucu
            )
        else:
            # Normal arazi vasfÄ± iÃ§in mevcut hesaplama (Dikili vasÄ±flÄ± dahil)
            
            # Manuel kontrol sonucundan alan deÄŸerlerini al (eÄŸer varsa)
            final_alan_m2 = alan_m2
            final_dikili_alani = dikili_alani
            
            if manuel_kontrol_sonucu and isinstance(manuel_kontrol_sonucu, dict):
                # DirectTransfer durumunda harita verilerini kullan
                if manuel_kontrol_sonucu.get('directTransfer'):
                    # Dikili vasÄ±flÄ± iÃ§in dikiliAlan'Ä± kullan
                    if arazi_vasfi == "Dikili vasÄ±flÄ±":
                        final_alan_m2 = manuel_kontrol_sonucu.get('dikiliAlan', alan_m2)
                        final_dikili_alani = manuel_kontrol_sonucu.get('dikiliAlan', dikili_alani)
                        logger.info(f"ğŸ—ºï¸ DirectTransfer (Dikili vasÄ±flÄ±) alan gÃ¼ncellendi: {alan_m2} â†’ {final_alan_m2}")
                    else:
                        # DiÄŸer arazi vasflarÄ± iÃ§in alan_m2 kullan
                        final_alan_m2 = manuel_kontrol_sonucu.get('alan_m2', alan_m2)
                        logger.info(f"ğŸ—ºï¸ DirectTransfer alan gÃ¼ncellendi: {alan_m2} â†’ {final_alan_m2}")
            
            arazi_bilgileri = {
                'ana_vasif': arazi_vasfi,
                'buyukluk_m2': final_alan_m2,
                'buyuk_ova_icinde': False,
                'dikili_alani': final_dikili_alani  # Dikili vasÄ±flÄ± iÃ§in dikili alan da ekle
            }
            # "Dikili vasÄ±flÄ±" iÃ§in de manuel kontrol sonucunu geÃ§ir
            result = bag_evi.bag_evi_degerlendir(
                arazi_bilgileri, 
                {}, 
                bag_evi_var_mi, 
                manuel_kontrol_sonucu
            )
        
        # Frontend iÃ§in uygun format
        return Response({
            'success': True,
            'data': {
                'alan_m2': arazi_bilgileri.get('buyukluk_m2', 0),
                'arazi_alani': arazi_bilgileri.get('buyukluk_m2', 0),
                'maksimum_insaat_alani': 150,
                'taban_alani': 75,
                'izin_durumu': result.get('izin_durumu', ''),
                'mesaj': result.get('ana_mesaj', '') + (
                    f"<br><br>{result.get('uyari_mesaji_ozel_durum', '')}" if result.get('uyari_mesaji_ozel_durum') else ""
                )
            },
            'message': 'BaÄŸ evi hesaplama baÅŸarÄ±yla tamamlandÄ±'
        })
    except Exception as e:
        logger.error(f"Bag evi calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'BaÄŸ evi hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_soguk_hava_deposu(request):
    """SoÄŸuk hava deposu hesaplamasÄ± (ID: 16)"""
    try:
        logger.info(f"Soguk hava deposu calculation request: {request.data}")
        # Dummy response ile tamamlandÄ± (hesaplama fonksiyonu eksikse sistem stabil kalsÄ±n diye)
        return Response({
            'success': True,
            'message': 'SoÄŸuk hava deposu hesaplama (dummy response)',
            'data': None
        })
    except Exception as e:
        logger.error(f"Soguk hava deposu calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'SoÄŸuk hava deposu hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def calculate_tarimsal_amacli_depo(request):
    """TarÄ±msal amaÃ§lÄ± depo hesaplamasÄ± (ID: 6)"""
    try:
        logger.info(f"TarÄ±msal amaÃ§lÄ± depo calculation request: {request.data}")
        # Dummy response ile tamamlandÄ± (hesaplama fonksiyonu eksikse sistem stabil kalsÄ±n diye)
        return Response({
            'success': True,
            'message': 'TarÄ±msal amaÃ§lÄ± depo hesaplama (dummy response)',
            'data': None
        })
    except Exception as e:
        logger.error(f"TarÄ±msal amaÃ§lÄ± depo calculation error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'TarÄ±msal amaÃ§lÄ± depo hesaplama sÄ±rasÄ±nda hata oluÅŸtu'
        }, status=status.HTTP_400_BAD_REQUEST)

# Static dosya servisleri
@api_view(['GET'])
def get_yonetmelikler(request):
    return Response({
        'success': True,
        'message': 'Yonetmelikler endpoint ready',
        'data': []
    })

@api_view(['GET'])
def get_kml_files(request):
    return Response({
        'success': True,
        'message': 'KML files endpoint ready',
        'data': []
    })

@api_view(['GET'])
def get_arazi_tipleri(request):
    """Arazi tiplerini dÃ¶ndÃ¼ren endpoint"""
    try:
        return Response({
            'success': True,
            'data': constants.ARAZI_TIPLERI,
            'message': 'Arazi tipleri baÅŸarÄ±yla getirildi'
        })
    except Exception as e:
        logger.error(f"Arazi tipleri error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'Arazi tipleri getirilirken hata oluÅŸtu'
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

@api_view(['GET'])
def get_yapi_turleri(request):
    """YapÄ± tÃ¼rlerini dÃ¶ndÃ¼ren endpoint"""
    try:
        return Response({
            'success': True,
            'data': constants.YAPI_TURLERI,
            'message': 'YapÄ± tÃ¼rleri baÅŸarÄ±yla getirildi'
        })
    except Exception as e:
        logger.error(f"YapÄ± tÃ¼rleri error: {str(e)}")
        return Response({
            'success': False,
            'error': str(e),
            'message': 'YapÄ± tÃ¼rleri getirilirken hata oluÅŸtu'
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
