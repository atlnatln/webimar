<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dikili Vasıf Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #27ae60; }
        .error { background: #f8d7da; border-color: #dc3545; }
        .warning { background: #fff3cd; border-color: #ffc107; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 "… Adetli Zeytin Ağacı bulunan + herhangi bir dikili vasıf" Debug Test</h1>
        
        <div class="test-section">
            <h2>📝 Test Formu</h2>
            <form id="testForm">
                <div class="form-group">
                    <label>Arazi Vasfı:</label>
                    <select id="arazi_vasfi" name="arazi_vasfi" required>
                        <option value="">Seçiniz...</option>
                        <option value="… Adetli Zeytin Ağacı bulunan + herhangi bir dikili vasıf">… Adetli Zeytin Ağacı bulunan + herhangi bir dikili vasıf</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Dikili Alan (m²):</label>
                    <input type="number" id="dikili_alani" name="dikili_alani" value="5000" min="1" required>
                </div>
                
                <div class="form-group">
                    <label>Tapu Zeytin Ağacı Sayısı:</label>
                    <input type="number" id="tapu_zeytin_agac_adedi" name="tapu_zeytin_agac_adedi" value="20" min="1" required>
                </div>
                
                <div class="form-group">
                    <label>Mevcut Zeytin Ağacı Sayısı:</label>
                    <input type="number" id="mevcut_zeytin_agac_adedi" name="mevcut_zeytin_agac_adedi" value="20" min="1" required>
                </div>
                
                <button type="button" class="btn-primary" onclick="simulateFrontendProcess()">🧮 Frontend Simülasyonu</button>
                <button type="button" class="btn-success" onclick="directApiTest()">🚀 Direct API Test</button>
            </form>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function getFormData() {
            const form = document.getElementById('testForm');
            const formData = new FormData(form);
            
            return {
                arazi_vasfi: formData.get('arazi_vasfi'),
                dikili_alani: parseInt(formData.get('dikili_alani')),
                tapu_zeytin_agac_adedi: parseInt(formData.get('tapu_zeytin_agac_adedi')),
                mevcut_zeytin_agac_adedi: parseInt(formData.get('mevcut_zeytin_agac_adedi')),
                bag_evi_var_mi: false
            };
        }
        
        function simulateFrontendProcess() {
            const formData = getFormData();
            
            console.log('🔄 Frontend Simülasyonu Başlatılıyor...');
            
            // Frontend'in yaptığı işlemi simüle et
            const finalFormData = { ...formData };
            
            // CalculationForm.tsx'teki mantığı taklit et
            if (formData.arazi_vasfi === '… Adetli Zeytin Ağacı bulunan + herhangi bir dikili vasıf') {
                // Alan mapping
                finalFormData.alan_m2 = finalFormData.dikili_alani || 0;
                
                // Math.max() logic
                const tapuAgacSayisi = finalFormData.tapu_zeytin_agac_adedi || 0;
                const mevcutAgacSayisi = finalFormData.mevcut_zeytin_agac_adedi || 0;
                const kullanilacakAgacSayisi = Math.max(tapuAgacSayisi, mevcutAgacSayisi);
                
                finalFormData.zeytin_agac_adedi = kullanilacakAgacSayisi;
                
                console.log('🫒 Frontend Processing:');
                console.log(`  dikili_alani: ${finalFormData.dikili_alani}`);
                console.log(`  alan_m2: ${finalFormData.alan_m2}`);
                console.log(`  tapu_agac: ${tapuAgacSayisi}`);
                console.log(`  mevcut_agac: ${mevcutAgacSayisi}`);
                console.log(`  kullanilacak_agac: ${kullanilacakAgacSayisi}`);
            }
            
            // API'ye gönderilecek final data
            showResult('Frontend Simülasyonu', finalFormData, 'warning');
            
            // API test de yap
            sendToApi(finalFormData, 'Frontend Simulated');
        }
        
        function directApiTest() {
            const formData = getFormData();
            
            // Direct API test - backend'in beklediği format
            const apiData = {
                arazi_vasfi: formData.arazi_vasfi,
                dikili_alani: formData.dikili_alani,
                alan_m2: formData.dikili_alani,  // dikili_alani ile aynı
                tapu_zeytin_agac_adedi: formData.tapu_zeytin_agac_adedi,
                mevcut_zeytin_agac_adedi: formData.mevcut_zeytin_agac_adedi,
                zeytin_agac_adedi: Math.max(formData.tapu_zeytin_agac_adedi, formData.mevcut_zeytin_agac_adedi),
                bag_evi_var_mi: false
            };
            
            showResult('Direct API Test', apiData, 'success');
            sendToApi(apiData, 'Direct API');
        }
        
        function sendToApi(data, testType) {
            fetch('http://127.0.0.1:8000/api/calculations/bag-evi/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log(`📊 ${testType} HTTP Status: ${response.status}`);
                return response.json();
            })
            .then(result => {
                console.log(`📥 ${testType} Response:`, result);
                showApiResult(testType, result);
            })
            .catch(error => {
                console.error(`💥 ${testType} Error:`, error);
                showApiResult(testType, { error: error.message }, true);
            });
        }
        
        function showResult(title, data, type) {
            const resultsDiv = document.getElementById('results');
            
            const section = document.createElement('div');
            section.className = `test-section ${type}`;
            section.innerHTML = `
                <h3>📤 ${title} - Gönderilecek Data</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            
            resultsDiv.appendChild(section);
        }
        
        function showApiResult(title, result, isError = false) {
            const resultsDiv = document.getElementById('results');
            
            const section = document.createElement('div');
            section.className = `test-section ${isError ? 'error' : 'success'}`;
            
            let content = `<h3>📥 ${title} - API Response</h3>`;
            
            if (isError) {
                content += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            } else if (result.success) {
                const mesaj = result.data.mesaj;
                const dikiliMatch = mesaj.match(/Dikili Alan: ([0-9,]+) m²/);
                
                content += `
                    <p><strong>✅ Başarılı:</strong> ${result.data.izin_durumu}</p>
                    <p><strong>🏠 Alan:</strong> ${result.data.alan_m2} m²</p>
                    <p><strong>🟢 Backend'de Dikili Alan:</strong> ${dikiliMatch ? dikiliMatch[1] : 'Bulunamadı'} m²</p>
                    <details>
                        <summary>📄 Tam Mesaj</summary>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px;">
                            ${mesaj}
                        </div>
                    </details>
                `;
            } else {
                content += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
            
            section.innerHTML = content;
            resultsDiv.appendChild(section);
        }
        
        // Sayfa yüklendiğinde default seçim yap
        window.onload = function() {
            document.getElementById('arazi_vasfi').value = '… Adetli Zeytin Ağacı bulunan + herhangi bir dikili vasıf';
        };
    </script>
</body>
</html>
